# 🚨 紧急诊断清单

## 请提供以下信息（复制粘贴即可）

### 1. 变差的具体表现

```
请粘贴训练前100轮的输出，包括：
- Epoch XX: W_dist=?, MAPE=?, ...
- 是否有报错信息
- 训练是否能正常进行
```

### 2. 你实施了哪些改动？

- [ ] 改动1：替换了损失函数（quick_fix_v1）
- [ ] 改动2：统一了季节噪声（quick_fix_v2）
- [ ] 改动3：调整了训练参数（epochs/batch_size/n_critic）
- [ ] 改动4：其他改动（请说明）

### 3. 对比指标

| 指标 | 改动前 | 改动后 | 变化 |
|-----|--------|--------|------|
| W距离（Epoch 100） | ? | ? | ? |
| Summer MAPE（最终） | ? | ? | ? |
| 整体MAPE（最终） | ? | ? | ? |
| 训练是否稳定 | ? | ? | ? |

### 4. 具体的"更差"是指？

- [ ] W距离更大（原来0.5，现在0.8）
- [ ] MAPE更高（原来400%，现在600%）
- [ ] 训练不稳定（损失剧烈波动）
- [ ] 完全不收敛（W距离一直很大）
- [ ] 生成的数据质量下降（更相似/更不真实）
- [ ] 其他问题：___________

---

## 🔄 快速回滚方案

如果情况紧急，先回滚到原始代码：

```bash
# 1. 恢复备份
cp your_script.py.backup your_script.py

# 2. 或者手动撤销改动
# - 把损失函数改回去
# - 把噪声生成改回去
# - 把训练参数改回去
```

然后我们重新分析问题。

---

## 可能的问题分析

基于经验，"改完更差"通常是以下原因之一：

### 原因A：改动过度（最常见）

**症状**：
- W距离从0.5跳到0.8+
- 损失剧烈波动
- 训练前50轮就崩溃

**可能原因**：
- 同时改了太多地方
- 损失权重调整过度
- 学习率不匹配新的损失函数

**快速修复**：
```python
# 只实施最小改动
# 仅改损失权重，其他保持不变

# 使用更保守的权重
total_loss_G = (
    loss_G + aux_loss_G +
    3.5 * similarity_loss +      # 5.0 → 3.5（保守降低）
    3.5 * mag_loss +              # 5.0 → 3.5
    1.0 * div_loss +              # 0.5 → 1.0（温和提高）
    1.2 * intra_div_loss +        # 0.8 → 1.2
    # 其他保持不变
)
```

---

### 原因B：代码修改位置错误

**症状**：
- 报错或者行为异常
- 某些损失项变成0
- 生成的数据范围异常

**可能原因**：
- 改动位置不对
- 缩进错误
- 变量名不匹配

**检查清单**：
```python
# 1. 检查导入是否在文件开头
from quick_fix_v1 import balanced_loss_function
from quick_fix_v2 import unified_season_noise

# 2. 检查函数调用参数
total_loss_G = balanced_loss_function(
    gen_curves,      # ✅ 正确
    real_curves,     # ✅ 正确
    season_vec,      # ✅ 正确
    loss_G,          # ✅ 正确
    aux_loss_G,      # ✅ 正确
    d_gen,           # ❌ 可能缺少？
    aux_gen,         # ❌ 可能缺少？
)

# 3. 检查设备匹配
z = unified_season_noise(
    batch_size, z_dim, noise_sigma, 
    epoch, epochs, 
    device  # ✅ 确保传入device
)
```

---

### 原因C：原始代码已经接近最优

**症状**：
- 改动前W距离已经<0.2
- 改动前MAPE已经<200%
- 改动后反而变差

**可能原因**：
- 你的代码实际上已经很好了
- 我的建议基于"Summer MAPE 400-500%"的假设
- 如果实际没那么差，就不需要大改

**解决方案**：
```python
# 如果原始效果已经不错，只做微调
# 例如：只降低10-20%的权重，而不是60%

total_loss_G = (
    loss_G + aux_loss_G +
    4.0 * similarity_loss +      # 5.0 → 4.0（微调）
    4.0 * mag_loss +              # 5.0 → 4.0
    0.7 * div_loss +              # 0.5 → 0.7（微调）
    1.0 * intra_div_loss +        # 0.8 → 1.0
    # 其他保持不变
)
```

---

### 原因D：批次大小/学习率不匹配

**症状**：
- 训练初期就崩溃
- 损失变成NaN
- 梯度爆炸

**可能原因**：
- 批次大小从64降到32，但损失权重没调整
- 新的损失函数需要不同的学习率

**快速修复**：
```python
# 降低学习率
lr_G = 1e-4  # 原来2e-4
lr_D = 5e-5  # 原来1e-4

# 或者恢复批次大小
batch_size = 64  # 不要降到32
```

---

### 原因E：忘记移除原来的损失项

**症状**：
- 损失函数变得非常大
- 训练异常缓慢
- W距离无法下降

**可能原因**：
- 添加了新的损失函数，但没删除旧的
- 导致损失项重复累加

**检查代码**：
```python
# ❌ 错误示例：同时保留了旧的和新的
total_loss_G = (
    loss_G + aux_loss_G +
    5.0 * similarity_loss +  # 旧的
    # ... 其他旧的损失项
)
total_loss_G = balanced_loss_function(...)  # 新的，但旧的没删

# ✅ 正确做法：只保留一个
total_loss_G = balanced_loss_function(
    gen_curves, real_curves, season_vec,
    loss_G, aux_loss_G, d_gen, aux_gen
)
# 完全替换，不要累加
```

---

## 🎯 根据症状快速定位

### 症状1：W距离爆炸（0.5 → 1.5+）

**可能原因**：权重改得太激进

**修复**：使用保守权重
```python
# 保守版本
similarity_weight = 3.5  # 而不是2.0
diversity_weight = 1.0   # 而不是1.5
```

### 症状2：训练完全不收敛

**可能原因**：代码位置错误或参数传递错误

**修复**：仔细检查代码修改位置

### 症状3：某个季节特别差

**可能原因**：移除季节特殊处理后，该季节失去了必要的约束

**修复**：部分保留季节约束
```python
# 保留Summer的基本约束，但降低权重
if summer_mask.any():
    summer_loss = ...
    total_loss_G += 3.0 * summer_loss  # 而不是10.0
```

### 症状4：多样性下降

**可能原因**：多样性权重提高不够

**修复**：进一步提高多样性权重
```python
diversity_weight = 2.0  # 而不是1.5
intra_diversity_weight = 2.5  # 而不是2.0
```

---

## 📋 下一步行动

### 立即执行：

1. **回答诊断问题**（上面4个问题）
2. **提供训练输出**（前100轮的日志）
3. **说明具体哪里变差了**

### 我会：

1. 根据你的具体情况重新分析
2. 提供针对性的修复方案
3. 可能需要：
   - 更保守的权重调整
   - 渐进式优化（一次只改一个地方）
   - 完全不同的优化策略

---

## 💡 临时建议

在等待详细诊断期间，你可以尝试：

### 方案1：最小改动测试

```python
# 只改损失权重，其他全部保持不变
# 使用保守的权重调整

total_loss_G = (
    loss_G + aux_loss_G +
    4.0 * similarity_loss +      # 5.0 → 4.0（保守）
    4.0 * mag_loss +              # 5.0 → 4.0（保守）
    0.8 * div_loss +              # 0.5 → 0.8（保守）
    1.0 * intra_div_loss +        # 0.8 → 1.0（保守）
    
    # 阶段2损失保持不变
    3.0 * pointwise_loss +
    2.0 * segment_loss +
    2.0 * peak_valley_loss +
    1.5 * dist_loss +
    
    # 时序保持不变
    0.02 * temporal_loss +
    0.02 * freq_loss +
    
    # 风电约束保持不变
    2.0 * wind_physical_loss +
    5.0 * wind_physical_loss_v2 +
    10.0 * wind_constraint
)

# 噪声策略保持不变（不要改）
# 训练参数保持不变（不要改）
```

**只改权重，其他都不动**，运行100轮看看效果。

### 方案2：完全回滚，重新评估

如果方案1还是不行，说明：
- 可能原始代码的问题不是我分析的那样
- 需要重新诊断

---

## 🙏 请提供信息

请告诉我：
1. **具体的训练输出**（W距离、MAPE等）
2. **改动前后的对比**
3. **你实施了哪些改动**

这样我才能给出准确的解决方案！
