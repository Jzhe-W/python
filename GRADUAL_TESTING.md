# 🧪 渐进式测试方案 - 避免改动过度

> **如果一次性改动太多导致效果变差，使用这个方案**

## 📊 诊断：找出真正的问题

### Step 1: 恢复原始代码，记录基准

```python
# 1. 完全恢复原始代码
# 2. 运行100轮，记录：

baseline = {
    'epoch_100_w_dist': ?,       # 第100轮的W距离
    'epoch_100_loss_G': ?,       # 第100轮的生成器损失
    'epoch_100_loss_D': ?,       # 第100轮的判别器损失
    'summer_mape': ?,            # 最终Summer MAPE
    'overall_mape': ?,           # 最终整体MAPE
    'training_stable': True/False # 训练是否稳定
}
```

**关键问题**：你的原始代码实际效果如何？

- 如果 W距离 < 0.2，Summer MAPE < 200%
  → 你的代码已经很好了，**不需要大改**
  
- 如果 W距离 0.2-0.5，Summer MAPE 200-400%
  → 需要适度优化，使用**保守方案**
  
- 如果 W距离 > 0.5，Summer MAPE > 400%
  → 需要深度优化，但要**逐步测试**

---

## 🧪 渐进式测试（一次只改一个地方）

### 测试1：只降低相似性权重（最保守）

```python
# 只改1个数字：相似性权重 5.0 → 4.5
total_loss_G = (
    loss_G + aux_loss_G +
    4.5 * similarity_loss +      # ⬅️ 唯一改动：5.0 → 4.5（只降10%）
    5.0 * mag_loss +              # 保持不变
    0.5 * div_loss +              # 保持不变
    0.8 * intra_div_loss +        # 保持不变
    # ... 其他全部保持不变
)
```

**运行100轮，观察**：
- W距离是否下降？
- 训练是否稳定？
- MAPE是否改善？

**结果判断**：
- ✅ W距离下降，训练稳定 → 继续测试2
- ⚠️ 没有明显变化 → 调整幅度太小，尝试4.0
- ❌ W距离上升 → 说明相似性权重不是问题，恢复5.0

---

### 测试2：提高多样性权重

```python
# 在测试1的基础上，再改1个数字
total_loss_G = (
    loss_G + aux_loss_G +
    4.5 * similarity_loss +      # 测试1已改
    5.0 * mag_loss +
    0.7 * div_loss +              # ⬅️ 新改动：0.5 → 0.7（提高40%）
    0.8 * intra_div_loss +
    # ... 其他保持不变
)
```

**运行100轮，对比测试1**：
- 多样性是否提升？
- W距离是否继续下降？

**结果判断**：
- ✅ 有改善 → 继续测试3
- ⚠️ 变差 → 恢复0.5，多样性权重不是问题
- ❌ 大幅变差 → 说明你的问题不是多样性不足

---

### 测试3：降低Summer约束

```python
# 在测试2的基础上，再改1个数字
# 找到Summer约束部分
if summer_mask.any():
    ...
    total_loss_G += 7.0 * wind_constraint  # ⬅️ 10.0 → 7.0（降低30%）
```

**运行100轮，重点观察Summer季节**：
- Summer MAPE是否改善？
- 其他季节是否受影响？

**结果判断**：
- ✅ Summer改善 → 成功找到问题
- ❌ Summer更差 → 恢复10.0，约束是必要的

---

### 测试4：微调噪声系数

```python
# 在测试3的基础上，微调噪声
if summer_mask.any():
    z = torch.randn(...) * (noise_sigma * 2.2) + noise_mu  # 2.5 → 2.2
elif winter_mask.any():
    z = torch.randn(...) * (noise_sigma * 1.8) + noise_mu  # 2.0 → 1.8
```

**运行100轮**：
- 生成质量是否改善？
- 季节特征是否更明显？

---

## 📊 测试记录表

| 测试 | 改动 | W距离 | Summer MAPE | 整体MAPE | 结论 |
|-----|------|-------|------------|---------|------|
| 基准 | 无 | ? | ? | ? | 原始性能 |
| 测试1 | 相似性4.5 | ? | ? | ? | ? |
| 测试2 | +多样性0.7 | ? | ? | ? | ? |
| 测试3 | +Summer约束7.0 | ? | ? | ? | ? |
| 测试4 | +噪声微调 | ? | ? | ? | ? |

---

## 🎯 根据测试结果决定最终方案

### 场景A：测试1就变差了

**说明**：相似性权重不是问题，可能是其他原因

**建议**：
1. 检查原始代码是否有误
2. 尝试只提高多样性权重（不降低相似性）
3. 或者你的代码已经很好，不需要改

### 场景B：测试1-2有改善，测试3变差

**说明**：损失权重调整有效，但Summer约束不应该降低

**建议**：
- 采用测试2的配置
- 保持Summer约束为10.0
- 或者寻找Summer的其他优化方向

### 场景C：所有测试都有改善

**说明**：优化方向正确

**建议**：
- 继续使用测试4的配置
- 可以考虑进一步调整（但要谨慎）
- 运行完整的1000轮训练

### 场景D：所有测试都没有明显变化

**说明**：调整幅度太小，或者优化方向错误

**建议**：
1. 增大调整幅度（例如5.0 → 4.0）
2. 或者问题不在损失权重，检查其他方面：
   - 数据质量
   - 模型架构
   - 训练策略

---

## 🔍 深度诊断：如果所有测试都失败

### 可能原因1：数据归一化问题

**检查**：
```python
print("真实数据范围:", data.min().min(), data.max().max())
print("归一化后范围:", data_norm.min().min(), data_norm.max().max())
print("生成数据范围:", fake_all.min(), fake_all.max())
print("反归一化后范围:", fake_denorm.min(), fake_denorm.max())

# 应该：
# 真实数据：0-几千 kW
# 归一化后：0-1
# 生成数据：-1到1 或 0-1
# 反归一化后：0-几千 kW（接近真实）
```

**如果异常**：
- 归一化后不在0-1 → 归一化有问题
- 生成数据超出范围 → 激活函数有问题
- 反归一化后差异巨大 → 反归一化错误

---

### 可能原因2：模型架构问题

**检查**：
```python
# 打印模型参数量
print("生成器参数:", sum(p.numel() for p in G.parameters()))
print("判别器参数:", sum(p.numel() for p in D.parameters()))

# 正常范围：
# 生成器：50万-200万参数
# 判别器：30万-150万参数
```

**如果异常**：
- 参数过少（<50万）→ 模型容量不足
- 参数过多（>500万）→ 可能过拟合

---

### 可能原因3：超参数问题

**检查**：
```python
print("学习率G:", lr_G)    # 应该：1e-4 到 5e-4
print("学习率D:", lr_D)    # 应该：5e-5 到 2e-4
print("批次大小:", batch_size)  # 应该：16-64
print("判别器更新:", n_critic)  # 应该：3-5
```

**如果异常**：
- 学习率过高（>1e-3）→ 训练不稳定
- 学习率过低（<1e-5）→ 收敛太慢
- 批次太小（<16）→ 训练不稳定
- 批次太大（>128）→ 泛化差

---

## 💡 最保守的改动（几乎零风险）

如果你不确定改什么，只改这3个数字：

```python
# 只改3个数字，其他一律不动
total_loss_G = (
    loss_G + aux_loss_G +
    4.8 * similarity_loss +      # 5.0 → 4.8（只降4%）
    5.0 * mag_loss +              # 不变
    0.55 * div_loss +             # 0.5 → 0.55（只增10%）
    0.8 * intra_div_loss +        # 不变
    # ... 其他全部不变
)
```

**预期**：
- 改善幅度：5-8%
- 风险：极低
- 适合：不确定问题在哪，想试试水

---

## 📋 下一步行动

1. **先诊断**：运行基准测试，记录原始性能
2. **渐进测试**：按照测试1→2→3→4的顺序
3. **记录结果**：每个测试都记录W距离、MAPE等
4. **选择方案**：根据测试结果选择最终配置

**重要提醒**：
- 每次只改一个地方
- 每次改动后都运行100轮
- 对比改动前后的指标
- 不要一次性改太多

---

## 🙋 需要帮助？

提供以下信息，我可以给出更具体的建议：

1. **基准性能**：原始代码的W距离、MAPE
2. **改动后性能**：改完后的W距离、MAPE
3. **测试结果**：按照上述渐进测试的结果
4. **具体症状**：训练日志、错误信息等

这样我才能准确判断问题所在！
